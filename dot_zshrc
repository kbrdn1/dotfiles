typeset -U path cdpath fpath manpath
for profile in ${(z)NIX_PROFILES}; do
  fpath+=($profile/share/zsh/site-functions $profile/share/zsh/$ZSH_VERSION/functions $profile/share/zsh/vendor-completions)
done

HELPDIR="/nix/store/2g3h900iy7ri455lyjycpmjx6fw8pgi4-zsh-5.9/share/zsh/$ZSH_VERSION/help"

# Add plugin directories to PATH and fpath
plugin_dirs=(
  zsh-autosuggestions zsh-syntax-highlighting powerlevel10k
)
for plugin_dir in "${plugin_dirs[@]}"; do
  path+="/Users/kbrdn1/.zsh/plugins/$plugin_dir"
  fpath+="/Users/kbrdn1/.zsh/plugins/$plugin_dir"
done
unset plugin_dir plugin_dirs


# oh-my-zsh extra settings for plugins

# oh-my-zsh configuration generated by NixOS
plugins=(macos git git-auto-fetch gh battery brew composer docker docker-compose alias-finder bun eza fzf history laravel symfony npm perms pip qrcode ssh systemadmin vi-mode web-search)


source $ZSH/oh-my-zsh.sh

eval "$(/nix/store/0s1z681g75shqzbvnn742rvispdhili8-zoxide-0.9.8/bin/zoxide init zsh )"

# Source plugins
plugins=(
  zsh-autosuggestions/share/zsh-autosuggestions/zsh-autosuggestions.zsh
  zsh-syntax-highlighting/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
  powerlevel10k/share/zsh-powerlevel10k/powerlevel10k.zsh-theme
)
for plugin in "${plugins[@]}"; do
  [[ -f "/Users/kbrdn1/.zsh/plugins/$plugin" ]] && source "/Users/kbrdn1/.zsh/plugins/$plugin"
done
unset plugin plugins

# History options should be set in .zshrc and after oh-my-zsh sourcing.
# See https://github.com/nix-community/home-manager/issues/177.
HISTSIZE="10000"
SAVEHIST="10000"

HISTFILE="/Users/kbrdn1/.zsh_history"
mkdir -p "$(dirname "$HISTFILE")"

setopt HIST_FCNTL_LOCK

# Enabled history options
enabled_opts=(
  HIST_IGNORE_DUPS HIST_IGNORE_SPACE SHARE_HISTORY
)
for opt in "${enabled_opts[@]}"; do
  setopt "$opt"
done
unset opt enabled_opts

# Disabled history options
disabled_opts=(
  APPEND_HISTORY EXTENDED_HISTORY HIST_EXPIRE_DUPS_FIRST HIST_FIND_NO_DUPS
  HIST_IGNORE_ALL_DUPS HIST_SAVE_NO_DUPS
)
for opt in "${disabled_opts[@]}"; do
  unsetopt "$opt"
done
unset opt disabled_opts

if [[ $options[zle] = on ]]; then
  source <(/nix/store/8xafvgyqh8v45s2ivpjh26i332ih2692-fzf-0.66.1/bin/fzf --zsh)
fi

# Nix daemon (multi-user mode)
if [ -e '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh' ]; then
  . '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'
fi

# Load secrets if they exist
[[ -f ~/.zsh_secrets ]] && source ~/.zsh_secrets

# History Configuration
HISTFILE=$HOME/.zhistory
SAVEHIST=1000
HISTSIZE=999
setopt share_history
setopt hist_expire_dups_first
setopt hist_ignore_dups
setopt hist_verify

bindkey '^[[A' history-search-backward
bindkey '^[[B' history-search-forward

# Alias Finder
zstyle ':omz:plugins:alias-finder' autoload yes
zstyle ':omz:plugins:alias-finder' longer yes
zstyle ':omz:plugins:alias-finder' exact yes
zstyle ':omz:plugins:alias-finder' cheaper yes

# VI Mode
VI_MODE_SET_CURSOR=true
MODE_INDICATOR="%F{white}+%f"
INSERT_MODE_INDICATOR="%F{yellow}+%f"
PROMPT="$PROMPT\$(vi_mode_prompt_info)"
RPROMPT="\$(vi_mode_prompt_info)$RPROMPT"
VI_MODE_CURSOR_NORMAL=2
VI_MODE_CURSOR_VISUAL=6
VI_MODE_CURSOR_INSERT=6
VI_MODE_CURSOR_OPPEND=0

# FZF Configuration
eval "$(fzf --zsh)"
export FZF_DEFAULT_OPTS="--style full \
  --border-label ' FZF ' --header-label ' File Type ' \
  --preview 'bat -n --color=always --line-range :500 {}' \
  --bind 'focus:transform-preview-label:[[ -n {} ]] && printf \" [%s] \" {}' \
  --bind 'focus:+transform-header:file --brief {} || echo \"No file selected\"' \
  --bind 'ctrl-r:change-list-label( Reloading the list )+reload(sleep 2; git ls-files)' \
  --color 'border:#494d64,label:#cad3f5' \
  --color 'preview-border:#8aadf4,preview-label:#b7bdf8' \
  --color 'list-border:#a6da95,list-label:#a6da95' \
  --color 'input-border:#ed8796,input-label:#f5a9b8' \
  --color 'header-border:#7dc4e4,header-label:#91d7e3'"
export FZF_CTRL_T_OPTS="$FZF_DEFAULT_OPTS"
export FZF_ALT_C_OPTS="--preview 'eza --tree --color=always {} | head -200'"

# FZF Functions
_fzf_compgen_path() {
  fd --hidden --exclude .git . "$1"
}

_fzf_compgen_dir() {
  fd --type d --hidden --exclude .git . "$1"
}

_fzf_comprun() {
  local command=$1
  shift

  case "$command" in
    cd) fzf --preview 'eza --tree --color=always {} | head -200' "$@" ;;
    export | unset) fzf --preview "eval 'echo \$' {}" "$@" ;;
    ssh) fzf --preview 'dig {}' "$@" ;;
    *) fzf --preview 'bat -n --color=always --line-range :500 {}' "$@" ;;
  esac
}

# Yazi Function
function y() {
  local tmp="$(mktemp -t "yazi-cwd.XXXXXX")" cwd
  yazi "$@" --cwd-file="$tmp"
  if cwd="$(command cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
    builtin cd -- "$cwd"
  fi
  rm -f -- "$tmp"
}

# Sketchybar Functions
function brew() {
  command brew "$@"
  if [[ $* =~ "upgrade" ]] || [[ $* =~ "update" ]] || [[ $* =~ "outdated" ]]; then
    sketchybar --trigger brew_update
  fi
}

function zen() {
  $XDG_CONFIG_HOME/sketchybar/plugins/zen.sh $1
}

# Load Powerlevel10k
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

if test -n "$KITTY_INSTALLATION_DIR"; then
  export KITTY_SHELL_INTEGRATION="no-rc"
  autoload -Uz -- "$KITTY_INSTALLATION_DIR"/shell-integration/zsh/kitty-integration
  kitty-integration
  unfunction kitty-integration
fi

eval "$(/nix/store/7jfl43irizm04l5qwyfqd6wbc919fimb-direnv-2.37.1/bin/direnv hook zsh)"

alias -- a='adonis ace'
alias -- adonis='node ace'
alias -- config='cd $XDG_CONFIG_HOME'
alias -- edit-borders='$EDITOR $XDG_CONFIG_HOME/borders'
alias -- edit-config='$EDITOR $XDG_CONFIG_HOME'
alias -- edit-nix='$EDITOR ~/nix-config/home.nix'
alias -- edit-p10k='$EDITOR ~/.p10k.zsh'
alias -- edit-sketchybar='$EDITOR $XDG_CONFIG_HOME/sketchybar'
alias -- edit-tmux='$EDITOR ~/.tmux.conf'
alias -- edit-zsh='$EDITOR ~/.zshrc'
alias -- f='fzf --tmux top,50%'
alias -- gca='gh copilot alias'
alias -- gcc='gh copilot config'
alias -- gce='gh copilot explain'
alias -- gcs='gh copilot suggest'
alias -- gg=google
alias -- laravel='php artisan'
alias -- lg=lazygit
alias -- ls='eza --color=always --long --git --no-filesize --icons=always --no-time --no-user --no-permissions --group-directories-first'
alias -- lzd=lazydocker
alias -- pa='php artisan'
alias -- py=python3
alias -- python=/usr/bin/python3
alias -- reload-borders='brew services restart borders'
alias -- reload-nix='nix run home-manager/release-24.11 -- switch --flake ~/nix-config'
alias -- reload-sketchybar='brew services restart sketchybar'
alias -- reload-tmux='tmux source-file ~/.tmux.conf'
alias -- reload-zsh='source ~/.zshrc'
alias -- t='tmux -2'
alias -- x=exit
alias -- yt=youtube